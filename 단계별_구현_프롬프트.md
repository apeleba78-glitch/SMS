# 공간 관리 시스템 — 단계별 구현 프롬프트

아래는 **한 번에 구현하지 않고 단계별로 진행**하기 위한 순서와, 각 단계에서 사용할 **프롬프트**입니다.  
각 프롬프트는 복사해서 그대로 사용하면 됩니다.  
**PROJECT_BASELINE.md**와 **이 프로젝트 개요**를 반드시 준수합니다.

---

## 단계 개요

| 단계 | 이름 | 목표 |
|------|------|------|
| 0 | DB·스키마 설계 | 교회/층/공간·상태·이력 구조 정의, enum·인덱스·RPC 스텁 |
| 1 | 공간 계층 (Church → Floor → Room) | 한 교회, 층, 공간 CRUD/시드 + 최소 목록 UI |
| 2 | 공간 카드·상태 (room_status) | 카드 4요소(청소/이슈/점검/비품) + 한 화면 한 API |
| 3 | 이슈(문제) 관리 핵심 | 접수→확인→처리중→해결/반려, 담당자·시간 기록 |
| 4 | 이슈 이미지 (Before/After) | WebP·1280px·300KB·경로만 DB 저장 |
| 5 | 청소 관리 | 청소 주기·일일 할당·완료 시 담당자·시간, room_status 연동 |
| 6 | 점검 체크리스트 | 공간별 템플릿·일일 계획 생성·완료 체크(공간 기준 공유) |
| 7 | 비품 부족 | 공간별 부족 물품·카드 표시 |
| 8 | 예약(사용 스케줄) | 누가·언제·어떤 공간 사용 (목록/간단 캘린더) |
| 9 | 역할·권한 | church_id 단위 권한, 수행자(member_id) 기록 |
| 10 | 마무리 | 성능·캐시·접근성 점검 |

---

## Phase 0 — DB·스키마 설계

**목표:** 교회·층·공간·상태·이력·권한을 담을 Supabase(PostgreSQL) 스키마를 설계하고, PROJECT_BASELINE과 프로젝트 개요에 맞게 enum·테이블·인덱스·RPC 스텁만 만든다. UI는 만들지 않는다.

---

### 📋 Phase 0 프롬프트 (복사용)

```
[컨텍스트]
- 이 프로젝트는 "건물 공간 관리 웹 시스템"이다. 공간(Room)이 관리의 핵심 단위다.
- 계층: Church → Floor → Room. 우선 교회 한 건물부터 진행한다.
- 반드시 준수할 문서: 프로젝트 루트의 PROJECT_BASELINE.md (전체)와, 프로젝트 개요(단계별_구현_프롬프트.md 상단 요약).

[요청]
Phase 0: DB·스키마 설계만 진행해줘.

1) 다음을 Supabase(PostgreSQL)에 정의해줘.
- church, floor, room 테이블 (계층 관계, FK, 인덱스)
- room_status 테이블: 현재 상태 전용 (청소 완료 여부, 미해결 이슈 수, 점검 완료율, 부족 비품 수 등). 실시간 계산 금지, 이벤트 기반 갱신만.
- 이슈(issue) 관련: 이슈 테이블 + 이슈 활동 로그 테이블 (로그와 상태 분리 원칙)
- 청소: 청소 주기·일일 할당·완료 기록용 테이블 (logs/status 분리)
- 점검: 공간별 점검 템플릿·일일 점검 계획·완료 기록용 테이블
- 비품 부족: 공간별 부족 물품 (또는 room_status에 반영하는 방식)
- 권한: church_id 단위 역할(admin, facility_lead, facility_sublead, staff 등), member/church 관계
- 모든 시간 컬럼은 timestamptz, timezone은 church.timezone 기준
- 상태값은 enum 타입으로 정의, magic string 금지
- PROJECT_BASELINE의 "모든 FK 인덱스", "room_status 주요 컬럼 인덱스", "날짜 기반 인덱스" 적용

2) 공간 상세 "한 화면 = 한 API"를 위해 RPC 스텁 하나 만들어줘.
- rpc_room_detail(room_id, date) — 나중에 구현할 것이므로, 반환 타입(컬럼 목록)만 정의하고 본문은 NULL 또는 빈 결과 반환으로 둬도 됨.

3) 마이그레이션 SQL 또는 Supabase SQL 에디터에서 실행할 수 있는 스크립트 형태로 제출해줘. 문서는 프로젝트/docs 또는 프로젝트/supabase/migrations 같은 곳에 저장해줘.
```

---

## Phase 1 — 공간 계층 (Church → Floor → Room)

**목표:** 한 교회, 그 안의 층(Floor), 층 안의 공간(Room)을 등록·조회할 수 있게 한다. 최소한의 목록 UI(모바일 우선, PROJECT_BASELINE UI 준수).

---

### 📋 Phase 1 프롬프트 (복사용)

```
[컨텍스트]
- 이 프로젝트는 "건물 공간 관리 웹 시스템"이다. 계층: Church → Floor → Room.
- 반드시 준수: PROJECT_BASELINE.md 전체. UI는 모바일 우선(360~430px), Flat, 카드 기반, 버튼 규격·문구 통일.

[요청]
Phase 1: 공간 계층 구현해줘.

1) Phase 0에서 만든 church, floor, room 테이블이 있다고 가정해.
   - 교회 1개, 층 여러 개, 층별 방(공간) 여러 개를 시드 데이터로 넣어줘 (예: 지하1층 식당/화장실, 1층 당목실/회의실 등).
   - 필요하면 Supabase 시드 SQL 또는 시드 스크립트를 만들어줘.

2) 프론트엔드(웹앱)를 만들어줘.
   - 기술: Next.js 또는 Vite + React. Supabase 클라이언트 사용.
   - 화면: "층 목록" → "해당 층의 공간(Room) 목록" (탭 3개 초과 금지, 한 화면 한 목적).
   - 디자인: PROJECT_BASELINE 1~1-4 절 (모바일 우선, 16px 패딩, radius 12~16px, 5색만, Primary 버튼 48px/14px/16px/600/100%).
   - 한 화면당 API 호출은 한 번으로. (예: 층 목록 한 번, 해당 층 공간 목록 한 번)

3) README 또는 docs에 "Phase 1 완료: 교회→층→공간 목록 조회" 요약을 추가해줘.
```

---

## Phase 2 — 공간 카드·상태 (room_status)

**목표:** 공간 카드에 필수 4요소(청소 상태, 미해결 이슈 수, 점검 완료율, 부족 비품 수)를 표시. room_status 기반, 한 화면 한 API(rpc_room_detail 또는 동등).

---

### 📋 Phase 2 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE.md: 공간 카드 필수 4요소 — 청소 상태, 미해결 이슈 수, 점검 완료율, 부족 비품 수. 실시간 계산 금지, room_status 등 사전 유지 테이블 사용.
- 한 화면 = 한 API 호출. 공간 상세는 rpc_room_detail(room_id, date) 하나만 호출.

[요청]
Phase 2: 공간 카드에 4요소 표시 + room_status 연동해줘.

1) room_status 테이블(또는 동등)에 "청소 상태", "미해결 이슈 수", "점검 완료율", "부족 비품 수"를 담을 수 있게 스키마가 있는지 확인하고, 없으면 추가해줘.

2) rpc_room_detail(room_id, date)를 구현해줘. 이 RPC 한 번으로 공간 기본 정보 + 위 4요소를 반환. select * 금지, 필요한 컬럼만. 사진은 URL/path만.

3) 프론트: 공간 목록/카드에서 위 4요소를 표시해줘. 색상은 PROJECT_BASELINE 1-3 (Neutral Gray, Green 600, Blue 600, Orange 500, Red 600)만 사용. 카드 클릭 시 공간 상세는 위 RPC 한 번만 호출해줘.
```

---

## Phase 3 — 이슈(문제) 관리 핵심

**목표:** 이슈 생애주기(접수→확인→처리중→해결완료/반려), 담당자·시간 자동 기록, 이슈 활동 로그(타임라인). 이미지는 Phase 4에서.

---

### 📋 Phase 3 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE.md: 상태는 직접 수정하지 않고 이벤트 기반 갱신. 이슈 생성 시 room_status.open_issue_count +1, 해결 시 -1.
- 로그 테이블은 이력 전용, status 테이블은 현재 상태 전용. 모든 변경에 수행자(member_id) 저장.

[요청]
Phase 3: 이슈(문제) 관리 핵심만 구현해줘.

1) 이슈 생애주기: 접수 → 확인 → 처리중 → 해결완료 또는 반려. 반려 시 반려 사유 저장.
   - 이슈 테이블: 공간(room_id), 문제 유형, 상세 설명, 현재 상태(enum), 접수자/접수시간, 확인자/확인시간, 해결자/해결시간, 반려자/반려시간.
   - 이슈 활동 로그 테이블: 이슈별 타임라인(접수 내용, 처리 메모, 해결 방법 등). 로그는 이력 전용, 상태와 분리.

2) 이벤트 기반 갱신: 이슈 생성 시 room_status.open_issue_count +1, 해결/반려 시 -1. RPC 또는 트리거로 구현.

3) API: 이슈 목록(공간/날짜 필터), 이슈 상세(한 번 호출로), 이슈 상태 변경(확인/처리중/해결/반려) 시 수행자·시간 자동 저장.

4) 프론트: 이슈 접수 폼, 이슈 목록·상세, 상태 변경 버튼(확인, 완료 처리, 해결 완료, 취소 등). 버튼 문구는 PROJECT_BASELINE 1-4 준수. 이미지 업로드는 Phase 4에서.
```

---

## Phase 4 — 이슈 이미지 (Before/After)

**목표:** 이슈 접수 시 Before, 해결 시 After 이미지. WebP, 긴쪽 1280px 이하, 300KB, 경로만 DB 저장. 저장 구조: issues/{issue_id}/before.webp, after.webp.

---

### 📋 Phase 4 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE.md 2장: 이미지 WebP, 긴쪽 1280px 이하, 최대 300KB, 품질 75~80, EXIF 제거, 원본 저장 금지. DB에는 경로만.
- 저장 구조: issues/{issue_id}/before.webp, issues/{issue_id}/after.webp.

[요청]
Phase 4: 이슈 이미지 업로드 구현해줘.

1) Supabase Storage에 issues/{issue_id}/before.webp, after.webp 구조로 저장되게 해줘.
2) 업로드 시 클라이언트 또는 엣지 함수에서 리사이즈·WebP 변환·압축(75~80)·300KB 이하·EXIF 제거 후 업로드해줘.
3) 이슈 테이블에 before_image_path, after_image_path(또는 동일 의미) 컬럼만 저장. select 시 URL 또는 path만 반환.
4) 프론트: 접수 폼에 Before 사진 첨부, 해결 완료 시 After 사진 첨부 UI 추가해줘.
```

---

## Phase 5 — 청소 관리

**목표:** 공간별 청소 주기, 매일 "오늘 청소할 공간 목록" 생성, 청소 완료 시 담당자·시간 기록, room_status.clean_done_today 등 반영.

---

### 📋 Phase 5 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE: 실시간 계산 금지. daily_task 사전 생성, 이벤트 기반 상태 업데이트. 청소 완료 → room_status.clean_done_today = true 등.

[요청]
Phase 5: 청소 관리 구현해줘.

1) 공간(room)별 청소 주기(매일, 주 2회 등) 설정 가능하게 해줘.
2) 매일 날짜 기준으로 "오늘 청소해야 할 공간 목록"(daily_task 또는 동등)을 사전 생성하는 로직(스케줄/크론 또는 Supabase Edge 등)을 만들어줘.
3) 청소 완료 시 담당자(member_id)·완료 시간 기록하고, room_status.clean_done_today(또는 동일 의미) 갱신해줘.
4) 프론트: 오늘 청소 대상 목록, 청소 완료 버튼(버튼 문구 "완료 처리" 등 PROJECT_BASELINE 준수). 공간 카드의 청소 상태는 Phase 2와 연동해줘.
```

---

## Phase 6 — 점검 체크리스트

**목표:** 공간별 점검 항목 템플릿, 날짜 기준 일일 점검 계획 자동 생성, 완료 체크 시 공간 기준 공유·기록.

---

### 📋 Phase 6 프롬프트 (복사용)

```
[컨텍스트]
- 공간마다 점검 항목 템플릿이 있음. 매일 "오늘 해야 할 점검 항목"이 자동 생성. 완료 상태는 공간 기준으로 공유(PROJECT_BASELINE: 로그와 상태 분리, room_status 점검 완료율 등).

[요청]
Phase 6: 점검 체크리스트 구현해줘.

1) 공간별 점검 템플릿(항목 목록) 테이블과, 날짜 기준 일일 점검 계획(daily checklist plan) 생성 로직을 만들어줘.
2) 직원이 항목별 완료 체크 시 기록 저장하고, room_status의 점검 완료율(또는 동일 지표)을 이벤트 기반으로 갱신해줘.
3) rpc_room_detail 또는 공간 상세 API에 "오늘 점검 완료율" 등이 포함되도록 해줘.
4) 프론트: 오늘 할 점검 항목 목록, 체크 시 완료 처리. 한 화면 한 목적, 모바일 우선 유지해줘.
```

---

## Phase 7 — 비품 부족

**목표:** 공간별 부족한 비품 등록·표시, 공간 카드 4요소 중 "부족 비품 수" 연동.

---

### 📋 Phase 7 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE: 공간 카드 필수 4요소에 "부족 비품 수" 포함. room_status 또는 별도 테이블로 유지.

[요청]
Phase 7: 비품 부족 관리 구현해줘.

1) 공간별 부족 비품을 등록·해제할 수 있는 테이블/API를 만들어줘. room_status의 부족 비품 수(또는 동등)를 이벤트 기반 갱신해줘.
2) rpc_room_detail 및 공간 카드에 부족 비품 수가 반영되도록 해줘.
3) 프론트: 공간별 부족 비품 등록/해제 UI, 카드에 4요소 중 하나로 표시해줘.
```

---

## Phase 8 — 예약(사용 스케줄)

**목표:** 누가, 언제, 어떤 공간을 사용하는지 등록·조회. 목록 또는 간단 캘린더.

---

### 📋 Phase 8 프롬프트 (복사용)

```
[컨텍스트]
- 공간별 사용 스케줄(예약): 누가, 언제, 어떤 공간 사용. 한 화면 한 API, 반환 데이터 최소화.

[요청]
Phase 8: 공간 사용 스케줄(예약) 구현해줘.

1) 예약 테이블: room_id, 사용자(member_id 또는 동등), 사용 시작·종료 시간(timestamptz), 용도 등. FK·날짜 인덱스 적용.
2) API: 특정 공간·날짜 기준 예약 목록 조회(한 번 호출). 필요한 컬럼만 반환.
3) 프론트: 공간별 또는 날짜별 예약 목록/간단 캘린더. 모바일 우선, 탭 3개 초과 금지해줘.
```

---

## Phase 9 — 역할·권한

**목표:** church_id 단위 권한(admin, facility_lead, facility_sublead, staff, 외주청소 등), 모든 주요 행동에 수행자(member_id) 기록.

---

### 📋 Phase 9 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE 7장: 권한은 church_id 단위. admin(전체), facility_lead(이슈 처리), facility_sublead(이슈 확인), staff(접수·완료 처리). 모든 변경 기록에 수행자(member_id) 자동 저장.
- 앱 사용자: 시스템 관리자, 건물 총관리자, 내부 직원(직급별 열람·체크리스트·문제 요청), 외주청소직원(체크리스트 위주).

[요청]
Phase 9: 역할·권한 구현해줘.

1) member, role, church 관계 테이블과 church_id 단위 권한(admin, facility_lead, facility_sublead, staff, external_cleaning 등)을 정의해줘.
2) API/DB: 이슈 접수·확인·해결·반려, 청소 완료, 점검 완료 등 모든 주요 행동에 수행자(member_id)가 반드시 저장되게 해줘. (이미 있는 곳은 검증만)
3) 프론트: 로그인/역할에 따라 메뉴·버튼 노출 제어(예: 부팀장은 이슈 확인만, 팀장은 해결까지). 시스템 관리자는 건물 총관리자 권한 부여·활성화/비활성화 등.
```

---

## Phase 10 — 마무리 (성능·캐시·접근성)

**목표:** 100명 이상 동시 사용 가정, N+1·select*·불필요 join 점검, 캐시·인덱스·접근성 정리.

---

### 📋 Phase 10 프롬프트 (복사용)

```
[컨텍스트]
- PROJECT_BASELINE 5장(성능), 11장(보완 기준): 100명 이상 동시 사용, FK·room_status·날짜 인덱스, N+1·select*·불필요 join 금지. 캐시·무효화, 접근성 최소 대응.

[요청]
Phase 10: 마무리 점검해줘.

1) DB: 모든 FK·room_status 주요 컬럼·날짜 기반 인덱스 재확인. N+1 가능성 있는 쿼리 제거, select * 제거, 불필요 join 제거.
2) API: 한 화면 한 호출 원칙 재확인. 필요 시 rpc_room_detail 등 응답에 캐시 힌트(또는 짧은 TTL) 적용 가능하면 문서화해줘.
3) 프론트: 주요 버튼·카드 포커스·스크린리더 최소 대응(PROJECT_BASELINE 11-5). 날짜 표시 church.timezone 통일 확인해줘.
4) docs에 "Phase 10 완료: 성능·접근성 점검" 요약을 추가해줘.
```

---

## 사용 방법

1. **Phase 0**부터 순서대로 진행하는 것을 권장합니다.
2. 각 단계 시작 전 해당 Phase의 **프롬프트 전체**를 복사해, 채팅 또는 에이전트에 붙여넣고 실행하세요.
3. 프로젝트 루트에 **PROJECT_BASELINE.md**와 이 **단계별_구현_프롬프트.md**가 있으면, 프롬프트만으로도 컨텍스트가 전달됩니다.
4. 특정 Phase만 다시 하고 싶을 때는 해당 Phase 프롬프트 + "이미 Phase N까지 완료된 상태에서" 같은 문장을 앞에 붙이면 됩니다.

---

*이 문서는 프로젝트의 단계별 구현 가이드이며, 모든 구현은 PROJECT_BASELINE.md를 벗어나지 않아야 한다.*
